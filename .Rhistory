}
}
write_lines <- lines[grepl("write\\.csv\\(", lines)]
if (length(write_lines) > 0) {
write_raw <- extract_group_matches(write_lines, pattern_paste0)
write_raw <- vapply(write_raw, normalize_relative_path, character(1))
write_raw <- write_raw[write_raw != ""]
write_onedrive <- extract_group_matches(write_lines, pattern_onedrive)
write_onedrive <- write_onedrive[is_file_like(write_onedrive)]
write_paths <- unique(c(write_paths, write_raw, write_onedrive))
}
}
# Generate raw inputs manifest from legacy scripts.
resolve_repo_root <- function() {
# Prefer rprojroot if available (most robust)
if (requireNamespace("rprojroot", quietly = TRUE)) {
return(rprojroot::find_root(rprojroot::is_git_root))
}
# Fallback: start from script path if we have it, otherwise from getwd()
args <- commandArgs(trailingOnly = FALSE)
file_arg <- grep("^--file=", args, value = TRUE)
start <- if (length(file_arg) > 0) {
sub("^--file=", "", file_arg[1])
} else if (!is.null(sys.frame(1)$ofile)) {
sys.frame(1)$ofile
} else {
""
}
d <- if (nzchar(start)) {
dirname(normalizePath(start, winslash = "/", mustWork = FALSE))
} else {
normalizePath(getwd(), winslash = "/", mustWork = FALSE)
}
# Walk up until we find a .git directory
while (!file.exists(file.path(d, ".git")) && dirname(d) != d) {
d <- dirname(d)
}
if (!file.exists(file.path(d, ".git"))) {
stop("Could not locate repo root (no .git found). Run from the repo directory or set OPSI_CONFIG/OPSI_WEIGHTS.")
}
d
}
if (!requireNamespace("yaml", quietly = TRUE)) {
stop("Package 'yaml' is required to write the manifest.")
}
repo_root <- resolve_repo_root()
legacy_dirs <- file.path(repo_root, c("legacy", "Legacy Scripts"))
legacy_dirs <- legacy_dirs[dir.exists(legacy_dirs)]
if (length(legacy_dirs) == 0) {
stop("No legacy script directories found.")
}
legacy_files <- sort(unlist(lapply(legacy_dirs, list.files,
pattern = "\\.R$", full.names = TRUE
)))
if (length(legacy_files) == 0) {
stop("No legacy R scripts found in: ", paste(legacy_dirs, collapse = ", "))
}
extract_group_matches <- function(lines, pattern) {
out <- character()
for (line in lines) {
matches <- regmatches(line, gregexpr(pattern, line, perl = TRUE))
if (length(matches) == 0 || length(matches[[1]]) == 0) {
next
}
for (match in matches[[1]]) {
out <- c(out, sub(pattern, "\\1", match, perl = TRUE))
}
}
out
}
normalize_relative_path <- function(path) {
cleaned <- trimws(path)
cleaned <- sub("^/+", "", cleaned)
cleaned
}
is_file_like <- function(path) {
!grepl("/$", path) && grepl("\\.[A-Za-z0-9]+$", path)
}
pattern_paste0 <- "paste0\\(\\s*raw_data\\s*,\\s*['\"]([^'\"]+)['\"]\\s*\\)"
pattern_file_path <- "file\\.path\\(\\s*raw_data\\s*,\\s*['\"]([^'\"]+)['\"]\\s*\\)"
pattern_onedrive <- "['\"](OneDrive - RMI/[^'\"]+)['\"]"
all_paths <- character()
write_paths <- character()
for (script in legacy_files) {
lines <- readLines(script, warn = FALSE)
paste0_paths <- extract_group_matches(lines, pattern_paste0)
file_path_paths <- extract_group_matches(lines, pattern_file_path)
onedrive_paths <- extract_group_matches(lines, pattern_onedrive)
onedrive_paths <- onedrive_paths[is_file_like(onedrive_paths)]
raw_paths <- c(paste0_paths, file_path_paths)
raw_paths <- vapply(raw_paths, normalize_relative_path, character(1))
raw_paths <- raw_paths[raw_paths != ""]
candidate_paths <- c(raw_paths, onedrive_paths)
if (length(candidate_paths) > 0) {
for (path in candidate_paths) {
if (!path %in% all_paths) {
all_paths <- c(all_paths, path)
}
}
}
write_lines <- lines[grepl("write\\.csv\\(", lines)]
if (length(write_lines) > 0) {
write_raw <- extract_group_matches(write_lines, pattern_paste0)
write_raw <- vapply(write_raw, normalize_relative_path, character(1))
write_raw <- write_raw[write_raw != ""]
write_onedrive <- extract_group_matches(write_lines, pattern_onedrive)
write_onedrive <- write_onedrive[is_file_like(write_onedrive)]
write_paths <- unique(c(write_paths, write_raw, write_onedrive))
}
}
# Generate raw inputs manifest from legacy scripts.
resolve_repo_root <- function() {
# Prefer rprojroot if available (most robust)
if (requireNamespace("rprojroot", quietly = TRUE)) {
return(rprojroot::find_root(rprojroot::is_git_root))
}
# Fallback: start from script path if we have it, otherwise from getwd()
args <- commandArgs(trailingOnly = FALSE)
file_arg <- grep("^--file=", args, value = TRUE)
start <- if (length(file_arg) > 0) {
sub("^--file=", "", file_arg[1])
} else if (!is.null(sys.frame(1)$ofile)) {
sys.frame(1)$ofile
} else {
""
}
d <- if (nzchar(start)) {
dirname(normalizePath(start, winslash = "/", mustWork = FALSE))
} else {
normalizePath(getwd(), winslash = "/", mustWork = FALSE)
}
# Walk up until we find a .git directory
while (!file.exists(file.path(d, ".git")) && dirname(d) != d) {
d <- dirname(d)
}
if (!file.exists(file.path(d, ".git"))) {
stop("Could not locate repo root (no .git found). Run from the repo directory or set OPSI_CONFIG/OPSI_WEIGHTS.")
}
d
}
if (!requireNamespace("yaml", quietly = TRUE)) {
stop("Package 'yaml' is required to write the manifest.")
}
repo_root <- resolve_repo_root()
legacy_dirs <- file.path(repo_root, c("legacy", "Legacy Scripts"))
legacy_dirs <- legacy_dirs[dir.exists(legacy_dirs)]
if (length(legacy_dirs) == 0) {
stop("No legacy script directories found.")
}
legacy_files <- sort(unlist(lapply(legacy_dirs, list.files,
pattern = "\\.R$", full.names = TRUE
)))
if (length(legacy_files) == 0) {
stop("No legacy R scripts found in: ", paste(legacy_dirs, collapse = ", "))
}
extract_group_matches <- function(lines, pattern) {
out <- character()
for (line in lines) {
matches <- regmatches(line, gregexpr(pattern, line, perl = TRUE))
if (length(matches) == 0 || length(matches[[1]]) == 0) {
next
}
for (match in matches[[1]]) {
out <- c(out, sub(pattern, "\\1", match, perl = TRUE))
}
}
out
}
normalize_relative_path <- function(path) {
cleaned <- trimws(path)
cleaned <- sub("^/+", "", cleaned)
cleaned
}
is_file_like <- function(path) {
path <- trimws(path)
nzchar(path) & !grepl("/$", path) & grepl("\\.[A-Za-z0-9]+$", path)
}
pattern_paste0 <- "paste0\\(\\s*raw_data\\s*,\\s*['\"]([^'\"]+)['\"]\\s*\\)"
pattern_file_path <- "file\\.path\\(\\s*raw_data\\s*,\\s*['\"]([^'\"]+)['\"]\\s*\\)"
pattern_onedrive <- "['\"](OneDrive - RMI/[^'\"]+)['\"]"
all_paths <- character()
write_paths <- character()
for (script in legacy_files) {
lines <- readLines(script, warn = FALSE)
paste0_paths <- extract_group_matches(lines, pattern_paste0)
file_path_paths <- extract_group_matches(lines, pattern_file_path)
onedrive_paths <- extract_group_matches(lines, pattern_onedrive)
onedrive_paths <- onedrive_paths[is_file_like(onedrive_paths)]
raw_paths <- c(paste0_paths, file_path_paths)
raw_paths <- vapply(raw_paths, normalize_relative_path, character(1))
raw_paths <- raw_paths[raw_paths != ""]
candidate_paths <- c(raw_paths, onedrive_paths)
if (length(candidate_paths) > 0) {
for (path in candidate_paths) {
if (!path %in% all_paths) {
all_paths <- c(all_paths, path)
}
}
}
write_lines <- lines[grepl("write\\.csv\\(", lines)]
if (length(write_lines) > 0) {
write_raw <- extract_group_matches(write_lines, pattern_paste0)
write_raw <- vapply(write_raw, normalize_relative_path, character(1))
write_raw <- write_raw[write_raw != ""]
write_onedrive <- extract_group_matches(write_lines, pattern_onedrive)
write_onedrive <- write_onedrive[is_file_like(write_onedrive)]
write_paths <- unique(c(write_paths, write_raw, write_onedrive))
}
}
manifest_entries <- lapply(all_paths, function(path) {
entry <- list(path = path)
if (path %in% write_paths) {
entry$optional <- TRUE
}
entry
})
manifest_path <- file.path(repo_root, "config", "raw_inputs_manifest.yml")
if (!dir.exists(dirname(manifest_path))) {
dir.create(dirname(manifest_path), recursive = TRUE)
}
yaml::write_yaml(manifest_entries, manifest_path)
message("Wrote raw inputs manifest: ", manifest_path)
# Ingest raw sources from SharePoint into a snapshot folder.
if (!requireNamespace("yaml", quietly = TRUE)) {
stop("Package 'yaml' is required to load the manifest.")
}
repo_root <- getOption("opportunity_security.repo_root")
if (is.null(repo_root) || !nzchar(repo_root)) {
if (!requireNamespace("rprojroot", quietly = TRUE)) {
stop("Repo root not set. Run from the repo or set OPSI_CONFIG and OPSI_WEIGHTS.")
}
repo_root <- rprojroot::find_root(rprojroot::is_git_root, path = getwd())
}
if (is.null(repo_root) || !nzchar(repo_root)) {
stop("Repo root not set. Run from the repo or set OPSI_CONFIG and OPSI_WEIGHTS.")
}
config <- getOption("opportunity_security.config")
if (is.null(config)) {
config_path <- Sys.getenv("OPSI_CONFIG", file.path(repo_root, "config", "config.yml"))
if (!file.exists(config_path)) {
stop("Config file not found: ", config_path)
}
config <- yaml::read_yaml(config_path)
stop("Repo root not set. Run scripts/00_setup.R first.")
}
resolve_repo_root <- function() {
args <- commandArgs(trailingOnly = FALSE)
file_arg <- grep("^--file=", args, value = TRUE)
script_path <- if (length(file_arg) > 0) {
sub("^--file=", "", file_arg[1])
} else if (!is.null(sys.frame(1)$ofile)) {
sys.frame(1)$ofile
} else {
""
}
dirname(normalizePath(script_path, winslash = "/", mustWork = FALSE))
}
if (!requireNamespace("yaml", quietly = TRUE)) {
stop("Package 'yaml' is required to load the manifest.")
}
repo_root <- resolve_repo_root()
config <- getOption("opportunity_security.config")
if (is.null(config)) {
stop("Config not loaded. Run scripts/00_setup.R first.")
}
if (is.null(config$sharepoint_raw_dir)) {
stop("Config is missing sharepoint_raw_dir.")
}
if (is.null(config$raw_data_dir)) {
stop("Config is missing raw_data_dir.")
}
sharepoint_raw_dir <- config$sharepoint_raw_dir
raw_data_dir <- file.path(repo_root, config$raw_data_dir)
manifest_path <- file.path(repo_root, "config", "raw_inputs_manifest.yml")
if (!file.exists(manifest_path)) {
stop("Raw inputs manifest not found: ", manifest_path)
}
# Ingest raw sources from SharePoint into a snapshot folder.
resolve_repo_root <- function() {
# Prefer rprojroot if available (most robust)
if (requireNamespace("rprojroot", quietly = TRUE)) {
return(rprojroot::find_root(rprojroot::is_git_root))
}
# Fallback: start from script path if we have it, otherwise from getwd()
args <- commandArgs(trailingOnly = FALSE)
file_arg <- grep("^--file=", args, value = TRUE)
start <- if (length(file_arg) > 0) {
sub("^--file=", "", file_arg[1])
} else if (!is.null(sys.frame(1)$ofile)) {
sys.frame(1)$ofile
} else {
""
}
d <- if (nzchar(start)) {
dirname(normalizePath(start, winslash = "/", mustWork = FALSE))
} else {
normalizePath(getwd(), winslash = "/", mustWork = FALSE)
}
# Walk up until we find a .git directory
while (!file.exists(file.path(d, ".git")) && dirname(d) != d) {
d <- dirname(d)
}
if (!file.exists(file.path(d, ".git"))) {
stop("Could not locate repo root (no .git found). Run from the repo directory or set OPSI_CONFIG/OPSI_WEIGHTS.")
}
d
}
repo_root <- resolve_repo_root()
config_path <- Sys.getenv("OPSI_CONFIG", file.path(repo_root, "config", "config.yml"))
weights_path <- Sys.getenv("OPSI_WEIGHTS", file.path(repo_root, "config", "weights.yml"))
sharepoint_raw_dir <- config$sharepoint_raw_dir
raw_data_dir <- file.path(repo_root, config$raw_data_dir)
manifest_path <- file.path(repo_root, "config", "raw_inputs_manifest.yml")
if (!file.exists(manifest_path)) {
stop("Raw inputs manifest not found: ", manifest_path)
}
manifest <- yaml::read_yaml(manifest_path)
if (length(manifest) == 0) {
stop("Raw inputs manifest is empty: ", manifest_path)
}
snapshot_date <- format(Sys.Date(), "%Y-%m-%d")
snapshot_dir <- file.path(raw_data_dir, snapshot_date)
if (!dir.exists(snapshot_dir)) {
dir.create(snapshot_dir, recursive = TRUE)
}
missing <- character()
for (entry in manifest) {
if (is.null(entry$path) || !nzchar(entry$path)) {
next
}
is_optional <- isTRUE(entry$optional)
source_path <- file.path(sharepoint_raw_dir, entry$path)
dest_path <- file.path(snapshot_dir, entry$path)
if (!file.exists(source_path)) {
if (!is_optional) {
missing <- c(missing, entry$path)
}
next
}
dest_dir <- dirname(dest_path)
if (!dir.exists(dest_dir)) {
dir.create(dest_dir, recursive = TRUE)
}
copied <- file.copy(source_path, dest_path, overwrite = TRUE)
if (!copied) {
stop("Failed to copy raw input: ", source_path, " -> ", dest_path)
}
}
if (length(missing) > 0) {
missing_list <- paste(paste0("- ", missing), collapse = "\n")
stop("Missing required raw inputs in sharepoint_raw_dir:\n", missing_list)
}
# Energy access & consumption theme.
energy_access_consumption <- function(ei, base_year = 2019, target_year = 2024, gamma = 0.5) {
make_ec_long <- function(year) {
ei %>%
dplyr::filter(
Year == year,
Var %in% c("pop", "coalcons_ej", "oilcons_ej", "gascons_ej", "solar_ej", "wind_ej", "nuclear_ej"),
!grepl("World|Other|Total|OECD|OPEC", Country)
) %>%
dplyr::select(Country, Var, Value) %>%
tidyr::pivot_wider(names_from = Var, values_from = Value) %>%
dplyr::transmute(
Country,
coal_raw = coalcons_ej / pop,
oil_raw = oilcons_ej / pop,
gas_raw = gascons_ej / pop,
solar_raw = solar_ej / pop,
wind_raw = wind_ej / pop,
nuclear_raw = nuclear_ej / pop
) %>%
dplyr::mutate(dplyr::across(dplyr::ends_with("_raw"), ~dplyr::coalesce(.x, 0))) %>%
dplyr::mutate(
dplyr::across(
dplyr::ends_with("_raw"),
~median_scurve(.x, gamma = gamma),
.names = "{stringr::str_remove(.col, '_raw')}_index"
)
) %>%
tidyr::pivot_longer(
cols = -Country,
names_to = c("tech", "data_type"),
names_pattern = "(.*)_(raw|index)",
values_to = "value"
) %>%
dplyr::transmute(
Country,
tech = stringr::str_to_sentence(tech),
supply_chain = "Downstream",
category = "Energy Access",
variable = "Energy consumption per capita",
data_type,
value,
Year = year,
source = "EI Statistical Review of World Energy (2024)",
explanation = dplyr::case_when(
data_type == "raw" ~ stringr::str_glue("Per-capita {tech} consumption = {tech}cons_ej Ã· pop"),
data_type == "index" ~ stringr::str_glue("Normalized index of per-capita {tech} consumption"),
TRUE ~ NA_character_
)
)
}
ec_base <- make_ec_long(base_year)
ec_target <- make_ec_long(target_year)
ec_growth <- ec_base %>%
dplyr::inner_join(
ec_target,
by = c("Country", "tech", "supply_chain", "category", "variable", "data_type"),
suffix = c("_base", "_target")
) %>%
dplyr::filter(data_type == "raw") %>%
dplyr::mutate(growth_raw = (value_target - value_base) / value_base) %>%
dplyr::group_by(Country) %>%
dplyr::mutate(growth_index = median_scurve(growth_raw, gamma = gamma)) %>%
dplyr::ungroup() %>%
dplyr::select(-data_type) %>%
tidyr::pivot_longer(
cols = c(growth_raw, growth_index),
names_to = c("metric", "data_type"),
names_pattern = "(.*)_(raw|index)",
values_to = "value"
) %>%
dplyr::transmute(
Country,
tech = stringr::str_to_sentence(tech),
supply_chain = "Downstream",
category = "Energy Access",
variable = paste(variable, metric),
data_type,
value,
Year = paste0(base_year, "-", target_year),
source = "EI Statistical Review of World Energy (2024)",
explanation = dplyr::case_when(
data_type == "raw" ~ "Per-capita consumption growth between base and target years",
data_type == "index" ~ "Normalized index of per-capita consumption growth",
TRUE ~ NA_character_
)
)
dplyr::bind_rows(ec_target, ec_growth)
}
if (!exists("repo_root")) {
repo_root <- resolve_repo_root()
}
source(file.path(repo_root, "R", "utils", "scurve.R"))
source(file.path(repo_root, "R", "themes", "energy_security", "energy_access_consumption.R"))
config <- getOption("opportunity_security.config")
if (is.null(config)) {
stop("Config not loaded; run scripts/00_setup.R first.")
}
processed_dir <- config$processed_dir
if (is.null(processed_dir)) {
stop("Config missing processed_dir.")
}
processed_path <- file.path(repo_root, processed_dir, "ei_stat_review_world_energy.csv")
if (!file.exists(processed_path)) {
expected_list <- paste0("- ", processed_path)
stop("Missing required processed data. Expected processed files:\n", expected_list)
}
# Build theme-level tables.
if (!exists("repo_root")) {
repo_root <- resolve_repo_root()
}
source(file.path(repo_root, "R", "utils", "scurve.R"))
source(file.path(repo_root, "R", "themes", "energy_security", "energy_access_consumption.R"))
config <- getOption("opportunity_security.config")
if (is.null(config)) {
stop("Config not loaded; run scripts/00_setup.R first.")
}
raw_data_dir <- config$raw_data_dir
if (is.null(raw_data_dir)) {
stop("Config missing raw_data_dir.")
}
raw_path <- file.path(repo_root, raw_data_dir, "ei_stat_review_world_energy.csv")
if (!file.exists(raw_path)) {
expected_list <- paste0("- ", raw_path)
stop("Missing required raw data. Expected raw files:\n", expected_list)
}
# Build theme-level tables.
if (!exists("repo_root")) {
repo_root <- resolve_repo_root()
}
source(file.path(repo_root, "R", "utils", "scurve.R"))
source(file.path(repo_root, "R", "themes", "energy_security", "energy_access_consumption.R"))
config <- getOption("opportunity_security.config")
if (is.null(config)) {
stop("Config not loaded; run scripts/00_setup.R first.")
}
raw_data_dir <- config$raw_data_dir
if (is.null(raw_data_dir)) {
stop("Config missing raw_data_dir.")
}
raw_path <- file.path(repo_root, raw_data_dir, "ei_stat_review_world_energy.csv")
if (!file.exists(raw_path)) {
expected_list <- paste0("- ", raw_path)
stop("Missing required raw data. Expected raw files:\n", expected_list)
}
# Build theme-level tables.
if (!exists("repo_root")) {
repo_root <- resolve_repo_root()
}
source(file.path(repo_root, "R", "utils", "scurve.R"))
source(file.path(repo_root, "R", "themes", "energy_security", "energy_access_consumption.R"))
config <- getOption("opportunity_security.config")
if (is.null(config)) {
stop("Config not loaded; run scripts/00_setup.R first.")
}
raw_data_dir <- config$raw_data_dir
if (is.null(raw_data_dir)) {
stop("Config missing raw_data_dir.")
}
snapshot_dirs <- list.dirs(raw_base_dir, recursive = FALSE, full.names = TRUE)
